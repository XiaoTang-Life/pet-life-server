# Upstash Redis å®Œæ•´å®‰è£…æŒ‡å—

**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯å®‰è£…æŒ‡å—
**é¡¹ç›®**: Pet Life Server / XiaoTang-Life
**æ—¥æœŸ**: 2025-11-03
**çŠ¶æ€**: âœ… å·²éªŒè¯ï¼ˆæœ¬åœ°æµ‹è¯•æˆåŠŸï¼‰

---

## ğŸ“‹ ç›®å½•

1. [Upstash è´¦æˆ·åˆ›å»º](#upstash-è´¦æˆ·åˆ›å»º)
2. [Redis æ•°æ®åº“åˆ›å»º](#redis-æ•°æ®åº“åˆ›å»º)
3. [æœ¬åœ°å¼€å‘é…ç½®](#æœ¬åœ°å¼€å‘é…ç½®)
4. [è¿æ¥æµ‹è¯•](#è¿æ¥æµ‹è¯•)
5. [Vercel éƒ¨ç½²é…ç½®](#vercel-éƒ¨ç½²é…ç½®)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## Upstash è´¦æˆ·åˆ›å»º

### æ­¥éª¤ 1: è®¿é—® Upstash å®˜ç½‘

1. æ‰“å¼€ https://upstash.com
2. ç‚¹å‡»å³ä¸Šè§’ "Start Free" æˆ– "Sign Up"
3. é€‰æ‹©æ³¨å†Œæ–¹å¼ï¼š
   - GitHub è´¦æˆ·ç™»å½•ï¼ˆæ¨èï¼‰
   - Google è´¦æˆ·ç™»å½•
   - Email æ³¨å†Œ

### æ­¥éª¤ 2: å®Œæˆæ³¨å†Œ

- é€‰æ‹©ç”¨æˆ·åå’Œå¯†ç 
- éªŒè¯é‚®ç®±ï¼ˆå¦‚æœä½¿ç”¨ Email æ³¨å†Œï¼‰
- åŒæ„æœåŠ¡æ¡æ¬¾

å®Œæˆåï¼Œä½ ä¼šè¿›å…¥ Upstash æ§åˆ¶å°ã€‚

---

## Redis æ•°æ®åº“åˆ›å»º

### æ­¥éª¤ 1: åˆ›å»ºæ–°æ•°æ®åº“

1. åœ¨ Upstash æ§åˆ¶å°ï¼Œç‚¹å‡» **"Create Database"**
2. è¾“å…¥æ•°æ®åº“åç§°ï¼ˆä¾‹å¦‚ï¼š`xiaotang-life-redis`ï¼‰
3. é€‰æ‹©åŒºåŸŸï¼š
   - **æ¨è**: `us-east-1` (ç¾ä¸œ)
   - æˆ–é€‰æ‹©ç¦»ä½ æœ€è¿‘çš„åœ°åŒº
4. é€‰æ‹©è®¡åˆ’ï¼š**Free** (å…è´¹ç‰ˆè¶³å¤Ÿæµ‹è¯•)
5. ç‚¹å‡» **"Create"**

### æ­¥éª¤ 2: è·å–è¿æ¥ä¿¡æ¯

æ•°æ®åº“åˆ›å»ºå®Œæˆåï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªè¯¦æƒ…é¡µé¢ã€‚

åœ¨ **"Quickstart"** éƒ¨åˆ†ï¼Œç‚¹å‡» `.env.local` æ ‡ç­¾ï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
REDIS_URL="rediss://default:xxxxx@xxxxx.upstash.io:6379"
KV_REST_API_URL="https://xxxxx.upstash.io"
KV_REST_API_TOKEN="xxxxx"
```

**å…³é”®ä¿¡æ¯**ï¼š
- `REDIS_URL`: è¿™æ˜¯ä½ éœ€è¦ä¿å­˜çš„è¿æ¥å­—ç¬¦ä¸²
- `rediss://` è¡¨ç¤ºä½¿ç”¨ SSL/TLS åŠ å¯†è¿æ¥

---

## æœ¬åœ°å¼€å‘é…ç½®

### æ­¥éª¤ 1: åˆ›å»º `.env.local` æ–‡ä»¶

åœ¨ pet-life-server é¡¹ç›®æ ¹ç›®å½•ï¼Œåˆ›å»ºæˆ–ç¼–è¾‘ `.env.local` æ–‡ä»¶ï¼š

```bash
# Upstash Redis è¿æ¥é…ç½®
# ä» Upstash æ§åˆ¶å°å¤åˆ¶ä½ çš„ REDIS_URL
REDIS_URL="rediss://default:YOUR_PASSWORD@YOUR_HOST.upstash.io:6379"

# å¯é€‰ï¼šUpstash REST APIï¼ˆå¤‡é€‰è¿æ¥æ–¹å¼ï¼‰
KV_REST_API_URL="https://YOUR_HOST.upstash.io"
KV_REST_API_TOKEN="YOUR_TOKEN"
```

**å¦‚ä½•å¤åˆ¶ REDIS_URL**ï¼š
1. å›åˆ° Upstash æ§åˆ¶å°
2. æ‰¾åˆ°ä½ çš„æ•°æ®åº“è¯¦æƒ…é¡µ
3. åœ¨ "Quickstart" çš„ `.env.local` æ ‡ç­¾
4. ç‚¹å‡» `REDIS_URL` é‚£ä¸€è¡Œçš„å¤åˆ¶æŒ‰é’®
5. ç²˜è´´åˆ° `.env.local` æ–‡ä»¶ä¸­

### æ­¥éª¤ 2: æ›´æ–°é¡¹ç›®æ–‡ä»¶

ç¡®ä¿é¡¹ç›®ä¸­è¿™äº›æ–‡ä»¶å·²ç»æ›´æ–°ï¼š

**main.py** (å·²è‡ªåŠ¨æ›´æ–°):
```python
from dotenv import load_dotenv

# åŠ è½½æœ¬åœ°ç¯å¢ƒå˜é‡
load_dotenv()
load_dotenv(".env.local", override=True)
```

**src/life_adapter.py** (å·²è‡ªåŠ¨é…ç½®):
```python
# è‡ªåŠ¨ä¼˜å…ˆä½¿ç”¨ REDIS_URLï¼ˆUpstashï¼‰
redis_url = os.getenv("REDIS_URL") or os.getenv("KV_REST_API_URL")
```

### æ­¥éª¤ 3: å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

å…³é”®ä¾èµ–ï¼š
- `redis>=5.0.0` - Redis Python å®¢æˆ·ç«¯
- `python-dotenv==1.0.0` - ç¯å¢ƒå˜é‡åŠ è½½

---

## è¿æ¥æµ‹è¯•

### æ–¹æ³• 1: è¿è¡Œæµ‹è¯•è„šæœ¬

é¡¹ç›®ä¸­åŒ…å«äº†è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š

```bash
python3 test_redis_connection.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
============================================================
ğŸ” Upstash Redis è¿æ¥æµ‹è¯•
============================================================

ğŸ“ ä½¿ç”¨çš„ Redis URL:
   rediss://****:****@ace-cicada-32650.upstash.io:6379

â³ å°è¯•è¿æ¥ Redis...
âœ… è¿æ¥æˆåŠŸï¼Redis ping: True

â³ æµ‹è¯•è¯»å†™æ“ä½œ...
âœ… å†™å…¥æˆåŠŸ: xiaotang-test-key = Hello Upstash Redis!
âœ… è¯»å–æˆåŠŸ: xiaotang-test-key = Hello Upstash Redis!
âœ… æ•°æ®éªŒè¯é€šè¿‡ï¼

============================================================
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Upstash Redis è¿æ¥æ­£å¸¸
============================================================
```

### æ–¹æ³• 2: å¯åŠ¨æœåŠ¡å™¨å¹¶æµ‹è¯• API

```bash
# å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
python3 main.py

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
curl "http://localhost:8000/api/pet/status?device_id=test-device-001"
```

**æˆåŠŸå“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "device_id": "test-device-001",
    "pet_name": "å°ç³–",
    "internal_state": {...},
    "expression": {...},
    "simplified_state": {...}
  }
}
```

### æ–¹æ³• 3: åœ¨ Upstash æ§åˆ¶å°æ£€æŸ¥æ•°æ®

1. ç™»å½• Upstash æ§åˆ¶å°
2. é€‰æ‹©ä½ çš„æ•°æ®åº“
3. ç‚¹å‡» "CLI" æˆ– "Data Browser"
4. æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹æ•°æ®ï¼š
   ```
   keys life_*
   get life_test-device-001:rhythm
   get life_test-device-001:energy
   ```

---

## Vercel éƒ¨ç½²é…ç½®

### æ­¥éª¤ 1: è¿æ¥ Upstash åˆ° Vercel é¡¹ç›®

**æ–¹å¼ A: é€šè¿‡ Vercel Marketplaceï¼ˆæ¨èï¼‰**

1. ç™»å½• Vercel æ§åˆ¶å°
2. è¿›å…¥ä½ çš„é¡¹ç›®
3. ç‚¹å‡» "Storage" æˆ– "Integrations"
4. æœç´¢ "Upstash"
5. ç‚¹å‡» "Add" æˆ– "Connect"
6. é€‰æ‹©å…è´¹è®¡åˆ’
7. æˆæƒè¿æ¥
8. è‡ªåŠ¨æ·»åŠ  `REDIS_URL` ç¯å¢ƒå˜é‡

**æ–¹å¼ B: æ‰‹åŠ¨æ·»åŠ ç¯å¢ƒå˜é‡**

1. åœ¨ Vercel é¡¹ç›®çš„ "Settings" â†’ "Environment Variables"
2. æ·»åŠ æ–°å˜é‡ï¼š
   - åç§°: `REDIS_URL`
   - å€¼: ä½ ä» Upstash å¤åˆ¶çš„ REDIS_URL
3. ç‚¹å‡» "Save"

### æ­¥éª¤ 2: é‡æ–°éƒ¨ç½²

```bash
# æ¨é€ä»£ç æ›´æ”¹
git add .
git commit -m "feat: Add Upstash Redis configuration"
git push origin main

# Vercel ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°ç¯å¢ƒå˜é‡å¹¶éƒ¨ç½²
```

### æ­¥éª¤ 3: éªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼š

```bash
# æ£€æŸ¥éƒ¨ç½²æ—¥å¿—
vercel logs --follow

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä¿¡æ¯
# "Using RedisStorage with Upstash"
```

---

## å¸¸è§é—®é¢˜

### Q1: è¿æ¥å¤±è´¥ï¼Œæç¤º "Connection refused"

**åŸå› **ï¼š
- Upstash å®ä¾‹ç¦»çº¿æˆ–è¢«é™åˆ¶
- REDIS_URL ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `.env.local` ä¸­çš„ REDIS_URL æ˜¯å¦å®Œå…¨å¤åˆ¶
2. ç¡®ä¿æ²¡æœ‰å¤šä½™ç©ºæ ¼æˆ–æ¢è¡Œç¬¦
3. åœ¨ Upstash æ§åˆ¶å°ç¡®è®¤æ•°æ®åº“çŠ¶æ€æ˜¯ "Available"
4. å¦‚æœä½¿ç”¨äº†é˜²ç«å¢™/IP ç™½åå•ï¼Œç¡®ä¿ä½ çš„ IP è¢«å…è®¸

### Q2: "SSL: CERTIFICATE_VERIFY_FAILED"

**åŸå› **ï¼š
- SSL è¯ä¹¦éªŒè¯å¤±è´¥
- Python ç¼ºå°‘ CA è¯ä¹¦

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ›´æ–° certifi
pip install --upgrade certifi

# æˆ–è€…åœ¨è¿æ¥æ—¶ç¦ç”¨è¯ä¹¦éªŒè¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
export PYTHONHTTPSVERIFY=0
```

### Q3: æœ¬åœ°æµ‹è¯•æˆåŠŸï¼Œä½† Vercel éƒ¨ç½²å¤±è´¥

**åŸå› **ï¼š
- ç¯å¢ƒå˜é‡æœªæ­£ç¡®æ³¨å…¥
- Vercel æ„å»ºæ—¶æ²¡æœ‰åŠ è½½ `.env.local`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Vercel é¡¹ç›®è®¾ç½®ä¸­çš„ç¯å¢ƒå˜é‡æ˜¯å¦åŒ…å« `REDIS_URL`
2. é‡æ–°éƒ¨ç½²ï¼š`vercel redeploy`
3. æ£€æŸ¥ Vercel éƒ¨ç½²æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### Q4: å¦‚ä½•ç›‘æ§ Redis ä½¿ç”¨æƒ…å†µ

**åœ¨ Upstash æ§åˆ¶å°**ï¼š
1. æ‰“å¼€ä½ çš„æ•°æ®åº“è¯¦æƒ…é¡µ
2. æŸ¥çœ‹ "Stats" é€‰é¡¹å¡
3. å¯ä»¥çœ‹åˆ°ï¼š
   - å‘½ä»¤æ•°
   - å­˜å‚¨ä½¿ç”¨é‡
   - è¿æ¥æ•°

### Q5: å¦‚ä½•æ‰©å±•å­˜å‚¨å®¹é‡

**å…è´¹ç‰ˆé™åˆ¶**ï¼š
- 10,000 æ¡å‘½ä»¤/å¤©
- æœ€å¤š 256MB æ•°æ®

**å‡çº§æ–¹æ¡ˆ**ï¼š
1. åœ¨ Upstash æ§åˆ¶å°è¿›å…¥ä½ çš„æ•°æ®åº“
2. ç‚¹å‡» "Billing" æˆ– "Upgrade"
3. é€‰æ‹©ä»˜è´¹è®¡åˆ’

---

## æ¶æ„æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Pet Life Client                 â”‚
â”‚   (iOS / Android / Desktop)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ HTTP/REST
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pet Life Server (FastAPI)         â”‚
â”‚   - main.py (å…¥å£)                  â”‚
â”‚   - src/life_adapter.py             â”‚
â”‚   - src/models.py                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ redis:// (SSL)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Upstash Redis                   â”‚
â”‚   - xiaotang-life-redis             â”‚
â”‚   - Region: us-east-1               â”‚
â”‚   - Plan: Free / Paid               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‹ä¸€æ­¥

âœ… **å·²å®Œæˆ**ï¼š
- Upstash Redis æ•°æ®åº“åˆ›å»º
- æœ¬åœ°å¼€å‘é…ç½®
- è¿æ¥æµ‹è¯•æˆåŠŸ
- å® ç‰© API é›†æˆéªŒè¯

â³ **å¾…åš**ï¼š
- [ ] åœ¨ Vercel Marketplace ä¸­è¿æ¥ Upstashï¼ˆå¦‚æœè¿˜æœªè¿æ¥ï¼‰
- [ ] é…ç½® Vercel ç¯å¢ƒå˜é‡
- [ ] éƒ¨ç½²åˆ° Vercel å¹¶éªŒè¯
- [ ] è®¾ç½®ç›‘æ§å’Œå‘Šè­¦

---

## å‚è€ƒèµ„æº

- [Upstash Redis æ–‡æ¡£](https://upstash.com/docs/redis)
- [Upstash ä¸ Vercel é›†æˆ](https://upstash.com/docs/redis/features/integrations/vercel)
- [Pet Life Server Redis å­˜å‚¨é›†æˆæŒ‡å—](docs/Phase-5-Rediså­˜å‚¨é›†æˆ/Rediså­˜å‚¨é›†æˆæŒ‡å—.md)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)

---

**æœ€åæ›´æ–°**: 2025-11-03
**ç‰ˆæœ¬**: 1.0
**ä½œè€…**: Claude Code
**çŠ¶æ€**: âœ… å·²éªŒè¯å¹¶æµ‹è¯•å®Œæ¯•

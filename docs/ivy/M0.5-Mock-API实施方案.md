# M0.5 Mock API å®æ–½æ–¹æ¡ˆ

**æ–‡æ¡£çŠ¶æ€**: å®æ–½ä¸­  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-03  
**æœ€åæ›´æ–°**: 2025-11-03  
**ä½œè€…**: Ivy & AI Assistant  
**ç›¸å…³æ–‡æ¡£**: [Serverä¸ºçœŸæºæ¶æ„æ–¹æ¡ˆ.md](./Serverä¸ºçœŸæºæ¶æ„æ–¹æ¡ˆ.md)

---

## ğŸ“‹ ç›®å½•

- [1. æ–¹æ¡ˆæ¦‚è¿°](#1-æ–¹æ¡ˆæ¦‚è¿°)
- [2. å®æ–½è®¡åˆ’](#2-å®æ–½è®¡åˆ’)
- [3. Phase 1: Server Mock API å¼€å‘](#3-phase-1-server-mock-api-å¼€å‘)
- [4. Phase 2: Server éƒ¨ç½²åˆ° Vercel](#4-phase-2-server-éƒ¨ç½²åˆ°-vercel)
- [5. Phase 3: iOS Networking å±‚å®ç°](#5-phase-3-ios-networking-å±‚å®ç°)
- [6. Phase 4: æ”¹é€  HomeViewModel](#6-phase-4-æ”¹é€ -homeviewmodel)
- [7. Phase 5: æ›´æ–° App Group å­˜å‚¨](#7-phase-5-æ›´æ–°-app-group-å­˜å‚¨)
- [8. Phase 6: æ›´æ–° Widget æ•°æ®æº](#8-phase-6-æ›´æ–°-widget-æ•°æ®æº)
- [9. å®æ–½æ—¶é—´è¡¨](#9-å®æ–½æ—¶é—´è¡¨)
- [10. éªŒæ”¶æ ‡å‡†](#10-éªŒæ”¶æ ‡å‡†)

---

## 1. æ–¹æ¡ˆæ¦‚è¿°

### 1.1 ç›®æ ‡

å°† M0.5 çš„æœ¬åœ° Mock æ•°æ®åˆ‡æ¢ä¸º Server Mock APIï¼ŒéªŒè¯ iOS â†” Server é€šä¿¡æ¶æ„ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… **Life æ˜¯å”¯ä¸€çœŸæº**ï¼ˆé•¿æœŸæ¶æ„ï¼‰
- âœ… **Server å…ˆæä¾› Mock æ•°æ®**ï¼ˆM0.5 é˜¶æ®µï¼‰
- âœ… **iOS è°ƒç”¨ Server API**ï¼ˆéªŒè¯é€šä¿¡ï¼‰
- âœ… **M1.0 æ—¶åªéœ€æ›¿æ¢ Server å†…éƒ¨å®ç°**ï¼ˆAPI ä¸å˜ï¼‰

### 1.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         iOS Widget (M0.5)                â”‚
â”‚  - 7 ç§çŠ¶æ€å±•ç¤º âœ…                       â”‚
â”‚  - UI äº¤äº’ âœ…                            â”‚
â”‚  - ä» Server API è·å–æ•°æ® ğŸ†•             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†•ï¸ HTTPS (REST API)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    pet-life-server (M0.5 Mock)          â”‚
â”‚  - æä¾› Mock æ•°æ® ğŸ†•                     â”‚
â”‚  - ä¸è¿æ¥ Life å¼•æ“                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœªæ¥ (M1.0):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    pet-life-server (Real)               â”‚
â”‚  - è¿æ¥ micro-life-sim âœ…                â”‚
â”‚  - Life å¼•æ“æ¨è¿›æ—¶é—´ âœ…                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      micro-life-sim (å”¯ä¸€çœŸæº)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ç¡®è®¤çš„æŠ€æœ¯å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| **éƒ¨ç½²å¹³å°** | Vercel | å·²æœ‰åŸºç¡€è®¾æ–½ï¼Œå…è´¹é¢åº¦è¶³å¤Ÿ |
| **device_id** | UUID | ç®€å•ï¼Œå‡å°‘å¤æ‚åº¦ |
| **çŠ¶æ€ç®¡ç†** | ä¿æŒ M0.5 | 7 ç§çŠ¶æ€ + æ‰‹åŠ¨åˆ‡æ¢ |
| **æ‹‰å–é¢‘ç‡** | 60 ç§’ | æˆæœ¬ä½ï¼Œç”µé‡å‹å¥½ |
| **ç¦»çº¿ä½“éªŒ** | Level 1ï¼ˆåªè¯»ç¼“å­˜ï¼‰ | å®ç°ç®€å•ï¼Œç¬¦åˆæ¶æ„ |
| **å…¨å±€å…±äº«** | æ˜¯ | èµ„æºæ¶ˆè€— O(1)ï¼Œé€‚åˆéªŒè¯é˜¶æ®µ |

---

## 2. å®æ–½è®¡åˆ’

### 2.1 å¼€å‘é¡ºåº

```
Phase 1: Server Mock API å¼€å‘ (2-3 å°æ—¶)
   â†“
Phase 2: éƒ¨ç½²åˆ° Vercel (0.5 å°æ—¶)
   â†“
Phase 3: iOS Networking å±‚ (2-3 å°æ—¶)
   â†“
Phase 4: æ”¹é€  HomeViewModel (1-2 å°æ—¶)
   â†“
Phase 5: æ›´æ–° App Group å­˜å‚¨ (0.5 å°æ—¶)
   â†“
Phase 6: æ›´æ–° Widget æ•°æ®æº (1 å°æ—¶)
   â†“
éªŒæ”¶æµ‹è¯• (1 å°æ—¶)
```

**æ€»è®¡**ï¼š7-10 å°æ—¶

### 2.2 äº¤ä»˜ç‰©æ¸…å•

**Server ç«¯**ï¼š
- [ ] Mock æ•°æ®å®šä¹‰
- [ ] Mock æœåŠ¡å®ç°
- [ ] API ç«¯ç‚¹å®ç°
- [ ] æœ¬åœ°æµ‹è¯•è„šæœ¬
- [ ] Vercel éƒ¨ç½²é…ç½®
- [ ] éƒ¨ç½²éªŒè¯

**iOS ç«¯**ï¼š
- [ ] API æ•°æ®æ¨¡å‹
- [ ] é”™è¯¯å¤„ç†
- [ ] åŸºç¡€ HTTP å®¢æˆ·ç«¯
- [ ] å® ç‰© API æœåŠ¡
- [ ] æ”¹é€ åçš„ HomeViewModel
- [ ] æ›´æ–°çš„ App Group å­˜å‚¨
- [ ] æ›´æ–°çš„ Widget æ•°æ®æº

---

## 3. Phase 1: Server Mock API å¼€å‘

### 3.1 ç›®å½•ç»“æ„

```
pet-life-server/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ index.py                    # Vercel å…¥å£
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ mock/                       # ğŸ†• M0.5 Mock æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ mock_data.py            # Mock æ•°æ®å®šä¹‰
â”‚   â”‚   â””â”€â”€ mock_service.py         # Mock ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ models.py                   # Pydantic æ¨¡å‹
â”‚   â””â”€â”€ ...
â”œâ”€â”€ main.py                         # æœ¬åœ°å¼€å‘å…¥å£
â”œâ”€â”€ requirements.txt
â””â”€â”€ vercel.json
```

### 3.2 æ•°æ®æ¨¡å‹

```python
# src/models.py

from pydantic import BaseModel
from datetime import datetime
from typing import Dict, Optional

class PetExpression(BaseModel):
    """å® ç‰©è¡¨è¾¾ï¼ˆè„‰åŠ¨ã€é¢œè‰²ã€æ„Ÿå—ï¼‰"""
    pulse_rate: int
    color_hex: str
    feeling: str

class PetStateInfo(BaseModel):
    """å® ç‰©çŠ¶æ€ä¿¡æ¯"""
    current: str  # sleep/hungry/play/idle/bored/grumpy/sleepy
    widget_quote: str
    expression: PetExpression

class PetValues(BaseModel):
    """å® ç‰©æ•°å€¼"""
    energy: float  # 0-100
    hunger: float  # 0-100
    mood: float    # 0-100

class PetSnapshot(BaseModel):
    """å® ç‰©å®Œæ•´çŠ¶æ€å¿«ç…§"""
    device_id: str
    pet_name: str
    version: int
    updated_at: str  # ISO 8601 æ ¼å¼
    values: PetValues
    state: PetStateInfo

class APIResponse(BaseModel):
    """API ç»Ÿä¸€å“åº”æ ¼å¼"""
    success: bool
    data: PetSnapshot
    timestamp: str

class ChangeStateRequest(BaseModel):
    """åˆ‡æ¢çŠ¶æ€è¯·æ±‚ï¼ˆM0.5 ç‰¹æœ‰ï¼‰"""
    device_id: str
    state: str

class InteractRequest(BaseModel):
    """äº’åŠ¨è¯·æ±‚"""
    device_id: str
    action: str  # feed/play/greet
```

### 3.3 Mock æ•°æ®å®šä¹‰

```python
# src/mock/mock_data.py

from typing import Dict

# 7 ç§çŠ¶æ€çš„ Mock æ•°æ®
MOCK_STATE_DATA: Dict[str, Dict] = {
    'sleep': {
        'values': {'energy': 30.0, 'hunger': 50.0, 'mood': 40.0},
        'state': {
            'current': 'sleep',
            'widget_quote': 'å˜˜â€¦æˆ‘åœ¨ç¡è§‰',
            'expression': {
                'pulse_rate': 60,
                'color_hex': '#4B0082',  # Indigo
                'feeling': 'æ·±åº¦ä¼‘æ¯ä¸­'
            }
        }
    },
    'hungry': {
        'values': {'energy': 60.0, 'hunger': 85.0, 'mood': 50.0},
        'state': {
            'current': 'hungry',
            'widget_quote': 'æˆ‘é¥¿å•¦ï¼Œç»™æˆ‘åƒçš„ï¼',
            'expression': {
                'pulse_rate': 90,
                'color_hex': '#FF8C00',  # Orange
                'feeling': 'è‚šå­å’•å’•å«'
            }
        }
    },
    'play': {
        'values': {'energy': 85.0, 'hunger': 35.0, 'mood': 90.0},
        'state': {
            'current': 'play',
            'widget_quote': 'å˜¿å˜¿ï¼Œæ¥ç©å§ï¼',
            'expression': {
                'pulse_rate': 110,
                'color_hex': '#32CD32',  # Green
                'feeling': 'ç²¾åŠ›å……æ²›ï¼'
            }
        }
    },
    'idle': {
        'values': {'energy': 65.0, 'hunger': 45.0, 'mood': 60.0},
        'state': {
            'current': 'idle',
            'widget_quote': 'ä»Šå¤©å¥½åƒæœ‰ç‚¹æ— èŠ',
            'expression': {
                'pulse_rate': 85,
                'color_hex': '#4169E1',  # Blue
                'feeling': 'å¹³é™æ€è€ƒä¸­'
            }
        }
    },
    'bored': {
        'values': {'energy': 55.0, 'hunger': 50.0, 'mood': 45.0},
        'state': {
            'current': 'bored',
            'widget_quote': 'å¥½æ— èŠå•Š',
            'expression': {
                'pulse_rate': 75,
                'color_hex': '#808080',  # Gray
                'feeling': 'æ— æ‰€äº‹äº‹'
            }
        }
    },
    'grumpy': {
        'values': {'energy': 50.0, 'hunger': 60.0, 'mood': 25.0},
        'state': {
            'current': 'grumpy',
            'widget_quote': 'å“¼ï¼Œå¿ƒæƒ…ä¸å¥½',
            'expression': {
                'pulse_rate': 100,
                'color_hex': '#DC143C',  # Red
                'feeling': 'æœ‰ç‚¹çƒ¦èº'
            }
        }
    },
    'sleepy': {
        'values': {'energy': 40.0, 'hunger': 45.0, 'mood': 50.0},
        'state': {
            'current': 'sleepy',
            'widget_quote': 'å¥½å›°å‘€ï¼Œè¦ç¡è§‰äº†',
            'expression': {
                'pulse_rate': 70,
                'color_hex': '#9370DB',  # Purple
                'feeling': 'çœ¼çš®å¥½é‡'
            }
        }
    }
}

# é»˜è®¤çŠ¶æ€
DEFAULT_STATE = 'idle'
```

### 3.4 Mock æœåŠ¡å®ç°

```python
# src/mock/mock_service.py

from datetime import datetime
from typing import Dict
from ..models import PetSnapshot, PetValues, PetStateInfo, PetExpression
from .mock_data import MOCK_STATE_DATA, DEFAULT_STATE

class MockPetService:
    """
    M0.5 Mock å® ç‰©æœåŠ¡
    
    èŒè´£ï¼š
    - ç®¡ç†å†…å­˜ä¸­çš„å® ç‰©çŠ¶æ€
    - æä¾›çŠ¶æ€æŸ¥è¯¢å’Œåˆ‡æ¢
    - æ¨¡æ‹Ÿç®€å•çš„äº’åŠ¨æ•ˆæœ
    """
    
    def __init__(self):
        # ç®€å•çš„å†…å­˜å­˜å‚¨ï¼ˆM0.5 é˜¶æ®µè¶³å¤Ÿï¼‰
        self._states: Dict[str, Dict] = {}
    
    def get_state(self, device_id: str) -> PetSnapshot:
        """è·å–å® ç‰©çŠ¶æ€"""
        if device_id not in self._states:
            self._states[device_id] = self._create_initial_state(device_id)
        
        state_dict = self._states[device_id]
        return self._dict_to_snapshot(state_dict)
    
    def change_state(self, device_id: str, state: str) -> PetSnapshot:
        """åˆ‡æ¢çŠ¶æ€ï¼ˆM0.5 ç‰¹æœ‰ï¼‰"""
        if state not in MOCK_STATE_DATA:
            raise ValueError(f"Invalid state: {state}")
        
        mock_data = MOCK_STATE_DATA[state]
        current_version = self._states.get(device_id, {}).get('version', 0)
        
        self._states[device_id] = {
            'device_id': device_id,
            'pet_name': 'å°ç³–',
            'version': current_version + 1,
            'updated_at': datetime.utcnow().isoformat(),
            'values': mock_data['values'].copy(),
            'state': mock_data['state'].copy()
        }
        
        return self._dict_to_snapshot(self._states[device_id])
    
    def interact(self, device_id: str, action: str) -> PetSnapshot:
        """äº’åŠ¨ï¼ˆM0.5 Mock ç‰ˆæœ¬ï¼‰"""
        if action not in ['feed', 'play', 'greet']:
            raise ValueError(f"Invalid action: {action}")
        
        if device_id not in self._states:
            self._states[device_id] = self._create_initial_state(device_id)
        
        state = self._states[device_id]
        
        # ç®€å•æ¨¡æ‹Ÿäº’åŠ¨æ•ˆæœ
        if action == 'feed':
            state['values']['hunger'] = max(0, state['values']['hunger'] - 20)
            state['values']['mood'] = min(100, state['values']['mood'] + 10)
            state['state']['widget_quote'] = 'å¥½åƒï¼è°¢è°¢ä½ ~'
        elif action == 'play':
            state['values']['mood'] = min(100, state['values']['mood'] + 15)
            state['values']['energy'] = max(0, state['values']['energy'] - 10)
            state['state']['widget_quote'] = 'å¥½å¼€å¿ƒå•Šï¼'
        elif action == 'greet':
            state['values']['mood'] = min(100, state['values']['mood'] + 5)
            state['state']['widget_quote'] = 'å—¨ï¼è§åˆ°ä½ çœŸå¥½~'
        
        state['version'] += 1
        state['updated_at'] = datetime.utcnow().isoformat()
        
        return self._dict_to_snapshot(state)
    
    def _create_initial_state(self, device_id: str) -> Dict:
        """åˆ›å»ºåˆå§‹çŠ¶æ€"""
        idle_data = MOCK_STATE_DATA[DEFAULT_STATE]
        return {
            'device_id': device_id,
            'pet_name': 'å°ç³–',
            'version': 1,
            'updated_at': datetime.utcnow().isoformat(),
            'values': idle_data['values'].copy(),
            'state': idle_data['state'].copy()
        }
    
    def _dict_to_snapshot(self, state_dict: Dict) -> PetSnapshot:
        """å°†å­—å…¸è½¬æ¢ä¸º PetSnapshot"""
        return PetSnapshot(
            device_id=state_dict['device_id'],
            pet_name=state_dict['pet_name'],
            version=state_dict['version'],
            updated_at=state_dict['updated_at'],
            values=PetValues(**state_dict['values']),
            state=PetStateInfo(
                current=state_dict['state']['current'],
                widget_quote=state_dict['state']['widget_quote'],
                expression=PetExpression(**state_dict['state']['expression'])
            )
        )

# å…¨å±€å•ä¾‹
mock_service = MockPetService()
```

### 3.5 API ç«¯ç‚¹å®ç°

```python
# main.py

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from datetime import datetime

from src.models import APIResponse, ChangeStateRequest, InteractRequest
from src.mock.mock_service import mock_service

app = FastAPI(
    title="Pet Life Server (M0.5 Mock)",
    description="M0.5 Mock API - ä¸º iOS æä¾›æ¼”ç¤ºæ•°æ®",
    version="0.5.0"
)

# CORS é…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
async def root():
    """æ ¹è·¯å¾„"""
    return {
        "name": "Pet Life Server",
        "version": "M0.5-mock",
        "status": "running",
        "endpoints": {
            "status": "GET /api/pet/status?device_id=xxx",
            "change_state": "POST /api/pet/change-state",
            "interact": "POST /api/pet/interact",
            "health": "GET /health"
        }
    }

@app.get("/health")
async def health():
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "ok",
        "version": "M0.5-mock",
        "timestamp": datetime.utcnow().isoformat()
    }

@app.get("/api/pet/status", response_model=APIResponse)
async def get_pet_status(device_id: str):
    """è·å–å® ç‰©çŠ¶æ€"""
    try:
        snapshot = mock_service.get_state(device_id)
        return APIResponse(
            success=True,
            data=snapshot,
            timestamp=datetime.utcnow().isoformat()
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/pet/change-state", response_model=APIResponse)
async def change_pet_state(request: ChangeStateRequest):
    """åˆ‡æ¢å® ç‰©çŠ¶æ€ï¼ˆM0.5 ç‰¹æœ‰ APIï¼‰"""
    try:
        snapshot = mock_service.change_state(request.device_id, request.state)
        return APIResponse(
            success=True,
            data=snapshot,
            timestamp=datetime.utcnow().isoformat()
        )
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/pet/interact", response_model=APIResponse)
async def interact_with_pet(request: InteractRequest):
    """ä¸å® ç‰©äº’åŠ¨"""
    try:
        snapshot = mock_service.interact(request.device_id, request.action)
        return APIResponse(
            success=True,
            data=snapshot,
            timestamp=datetime.utcnow().isoformat()
        )
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 3.6 æœ¬åœ°æµ‹è¯•

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨æœ¬åœ°æœåŠ¡
python main.py
# æˆ–
uvicorn main:app --reload

# æµ‹è¯• API
curl http://localhost:8000/health
curl "http://localhost:8000/api/pet/status?device_id=test-123"
```

---

## 4. Phase 2: Server éƒ¨ç½²åˆ° Vercel

### 4.1 Vercel é…ç½®

```json
// vercel.json
{
  "version": 2,
  "builds": [
    {
      "src": "api/index.py",
      "use": "@vercel/python"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "api/index.py"
    }
  ],
  "env": {
    "PYTHON_VERSION": "3.11"
  }
}
```

### 4.2 Vercel å…¥å£

```python
# api/index.py

import sys
import os

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from main import app

handler = app
```

### 4.3 éƒ¨ç½²æ­¥éª¤

```bash
# 1. æäº¤ä»£ç 
git add .
git commit -m "feat: æ·»åŠ  M0.5 Mock API"
git push origin main

# 2. éƒ¨ç½²åˆ° Vercel
vercel --prod

# 3. éªŒè¯éƒ¨ç½²
curl https://pet-life-server.vercel.app/health
```

---

## 5. Phase 3: iOS Networking å±‚å®ç°

### 5.1 ç›®å½•ç»“æ„

```
Widget Pet/Widget Pet/Infra/Networking/
â”œâ”€â”€ APIClient.swift          # åŸºç¡€ HTTP å®¢æˆ·ç«¯
â”œâ”€â”€ PetAPIService.swift      # å® ç‰© API æœåŠ¡
â”œâ”€â”€ APIModels.swift          # API æ•°æ®æ¨¡å‹
â””â”€â”€ APIError.swift           # é”™è¯¯å¤„ç†
```

### 5.2 API æ•°æ®æ¨¡å‹

```swift
// Infra/Networking/APIModels.swift

import Foundation

struct APIResponse<T: Codable>: Codable {
    let success: Bool
    let data: T
    let timestamp: String
}

struct PetSnapshot: Codable, Equatable {
    let deviceId: String
    let petName: String
    let version: Int
    let updatedAt: String
    let values: PetValues
    let state: PetStateInfo
    
    enum CodingKeys: String, CodingKey {
        case deviceId = "device_id"
        case petName = "pet_name"
        case version
        case updatedAt = "updated_at"
        case values
        case state
    }
}

struct PetValues: Codable, Equatable {
    let energy: Double
    let hunger: Double
    let mood: Double
}

struct PetStateInfo: Codable, Equatable {
    let current: String
    let widgetQuote: String
    let expression: PetExpression
    
    enum CodingKeys: String, CodingKey {
        case current
        case widgetQuote = "widget_quote"
        case expression
    }
}

struct PetExpression: Codable, Equatable {
    let pulseRate: Int
    let colorHex: String
    let feeling: String
    
    enum CodingKeys: String, CodingKey {
        case pulseRate = "pulse_rate"
        case colorHex = "color_hex"
        case feeling
    }
}
```

### 5.3 HTTP å®¢æˆ·ç«¯

```swift
// Infra/Networking/APIClient.swift

import Foundation

class APIClient {
    static let shared = APIClient()
    
    private let baseURL: String = {
        #if DEBUG
        return "http://localhost:8000"
        #else
        return "https://pet-life-server.vercel.app"
        #endif
    }()
    
    private let session: URLSession
    private let timeout: TimeInterval = 10.0
    
    init() {
        let config = URLSessionConfiguration.default
        config.timeoutIntervalForRequest = timeout
        self.session = URLSession(configuration: config)
    }
    
    func request<T: Decodable>(
        path: String,
        method: String = "GET",
        body: Encodable? = nil,
        queryItems: [URLQueryItem]? = nil
    ) async throws -> T {
        // æ„å»º URL
        guard var urlComponents = URLComponents(string: baseURL + path) else {
            throw APIError.invalidURL
        }
        
        if let queryItems = queryItems {
            urlComponents.queryItems = queryItems
        }
        
        guard let url = urlComponents.url else {
            throw APIError.invalidURL
        }
        
        // æ„å»ºè¯·æ±‚
        var request = URLRequest(url: url)
        request.httpMethod = method
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        
        if let body = body {
            request.httpBody = try JSONEncoder().encode(body)
        }
        
        // å‘é€è¯·æ±‚
        let (data, response) = try await session.data(for: request)
        
        guard let httpResponse = response as? HTTPURLResponse else {
            throw APIError.invalidResponse
        }
        
        guard (200...299).contains(httpResponse.statusCode) else {
            let errorMessage = String(data: data, encoding: .utf8) ?? "Unknown error"
            throw APIError.serverError(httpResponse.statusCode, errorMessage)
        }
        
        return try JSONDecoder().decode(T.self, from: data)
    }
}
```

### 5.4 å® ç‰© API æœåŠ¡

```swift
// Infra/Networking/PetAPIService.swift

import Foundation

class PetAPIService {
    static let shared = PetAPIService()
    private let apiClient = APIClient.shared
    
    func getPetStatus(deviceId: String) async throws -> PetSnapshot {
        let response: APIResponse<PetSnapshot> = try await apiClient.request(
            path: "/api/pet/status",
            queryItems: [URLQueryItem(name: "device_id", value: deviceId)]
        )
        return response.data
    }
    
    func changeState(deviceId: String, state: String) async throws -> PetSnapshot {
        let request = ChangeStateRequest(deviceId: deviceId, state: state)
        let response: APIResponse<PetSnapshot> = try await apiClient.request(
            path: "/api/pet/change-state",
            method: "POST",
            body: request
        )
        return response.data
    }
    
    func interact(deviceId: String, action: String) async throws -> PetSnapshot {
        let request = InteractRequest(deviceId: deviceId, action: action)
        let response: APIResponse<PetSnapshot> = try await apiClient.request(
            path: "/api/pet/interact",
            method: "POST",
            body: request
        )
        return response.data
    }
}
```

---

## 6. Phase 4: æ”¹é€  HomeViewModel

```swift
// Features/Home/HomeViewModel.swift

@MainActor
final class HomeViewModel: ObservableObject {
    @Published var currentSnapshot: PetSnapshot?
    @Published var currentState: PetStateEnum
    @Published var isLoading: Bool = false
    @Published var isOffline: Bool = false
    @Published var errorMessage: String?
    
    private let apiService = PetAPIService.shared
    private let appGroupStorage = AppGroupStorage.shared
    private let deviceId: String
    
    private var pollingTimer: Timer?
    private let pollingInterval: TimeInterval = 60
    
    init() {
        self.deviceId = Self.getOrCreateDeviceId()
        self.currentSnapshot = appGroupStorage.loadSnapshot()
        self.currentState = PetStateEnum(rawValue: currentSnapshot?.state.current ?? "idle") ?? .idle
    }
    
    func startPolling() {
        Task { await fetchFromServer() }
        pollingTimer = Timer.scheduledTimer(withTimeInterval: pollingInterval, repeats: true) { [weak self] _ in
            Task { await self?.fetchFromServer() }
        }
    }
    
    func fetchFromServer() async {
        isLoading = true
        do {
            let snapshot = try await apiService.getPetStatus(deviceId: deviceId)
            self.currentSnapshot = snapshot
            self.currentState = PetStateEnum(rawValue: snapshot.state.current) ?? .idle
            self.isOffline = false
            appGroupStorage.saveSnapshot(snapshot)
            WidgetCenter.shared.reloadAllTimelines()
        } catch {
            self.isOffline = true
            if currentSnapshot == nil {
                currentSnapshot = appGroupStorage.loadSnapshot()
            }
        }
        isLoading = false
    }
    
    func changeState(to newState: PetStateEnum) {
        Task {
            do {
                let snapshot = try await apiService.changeState(deviceId: deviceId, state: newState.rawValue)
                self.currentSnapshot = snapshot
                self.currentState = newState
                appGroupStorage.saveSnapshot(snapshot)
                WidgetCenter.shared.reloadAllTimelines()
            } catch {
                errorMessage = error.localizedDescription
            }
        }
    }
    
    private static func getOrCreateDeviceId() -> String {
        let key = "device_id"
        if let existing = UserDefaults.standard.string(forKey: key) {
            return existing
        }
        let newId = UUID().uuidString
        UserDefaults.standard.set(newId, forKey: key)
        return newId
    }
}
```

---

## 7. Phase 5: æ›´æ–° App Group å­˜å‚¨

```swift
// Core/PetModels/PetStateStorage.swift

struct AppGroupStorage {
    static let shared = AppGroupStorage()
    private let appGroupID = "group.Sonya.WidgetPet"
    private let snapshotKey = "pet_snapshot"
    
    private var userDefaults: UserDefaults? {
        UserDefaults(suiteName: appGroupID)
    }
    
    func saveSnapshot(_ snapshot: PetSnapshot) {
        guard let data = try? JSONEncoder().encode(snapshot) else { return }
        userDefaults?.set(data, forKey: snapshotKey)
        userDefaults?.synchronize()
    }
    
    func loadSnapshot() -> PetSnapshot? {
        guard let data = userDefaults?.data(forKey: snapshotKey),
              let snapshot = try? JSONDecoder().decode(PetSnapshot.self, from: data) else {
            return nil
        }
        return snapshot
    }
}
```

---

## 8. Phase 6: æ›´æ–° Widget æ•°æ®æº

```swift
// WidgetExtension/WidgetPetWidget.swift

struct Provider: TimelineProvider {
    let appGroupStorage = AppGroupStorage.shared
    
    func getTimeline(in context: Context, completion: @escaping (Timeline<PetEntry>) -> Void) {
        let snapshot = appGroupStorage.loadSnapshot()
        let entry = PetEntry(date: Date(), snapshot: snapshot)
        let nextUpdate = Calendar.current.date(byAdding: .minute, value: 15, to: Date())!
        let timeline = Timeline(entries: [entry], policy: .after(nextUpdate))
        completion(timeline)
    }
}

struct PetWidgetView: View {
    let entry: PetEntry
    
    var body: some View {
        if let snapshot = entry.snapshot {
            VStack {
                Text(snapshot.state.widgetQuote)
                if let updatedDate = ISO8601DateFormatter().date(from: snapshot.updatedAt) {
                    Text("æ›´æ–°äº \(timeAgo(updatedDate))")
                        .font(.caption2)
                        .foregroundColor(.gray)
                }
            }
        } else {
            Text("æ‰“å¼€ App æŸ¥çœ‹å® ç‰©")
        }
    }
}
```

---

## 9. å®æ–½æ—¶é—´è¡¨

| Phase | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-------|------|---------|------|
| 1 | Server Mock API å¼€å‘ | 2-3 å°æ—¶ | â³ å¾…å¼€å§‹ |
| 2 | Server éƒ¨ç½²åˆ° Vercel | 0.5 å°æ—¶ | â³ å¾…å¼€å§‹ |
| 3 | iOS Networking å±‚å®ç° | 2-3 å°æ—¶ | â³ å¾…å¼€å§‹ |
| 4 | æ”¹é€  HomeViewModel | 1-2 å°æ—¶ | â³ å¾…å¼€å§‹ |
| 5 | æ›´æ–° App Group å­˜å‚¨ | 0.5 å°æ—¶ | â³ å¾…å¼€å§‹ |
| 6 | æ›´æ–° Widget æ•°æ®æº | 1 å°æ—¶ | â³ å¾…å¼€å§‹ |
| **æ€»è®¡** | | **7-10 å°æ—¶** | |

---

## 10. éªŒæ”¶æ ‡å‡†

### Server ç«¯

- [ ] æ‰€æœ‰ API ç«¯ç‚¹å¯è®¿é—®
- [ ] 7 ç§çŠ¶æ€éƒ½èƒ½æ­£ç¡®è¿”å›
- [ ] äº’åŠ¨åŠŸèƒ½å·¥ä½œæ­£å¸¸
- [ ] éƒ¨ç½²åˆ° Vercel æˆåŠŸ
- [ ] å“åº”æ—¶é—´ < 500ms
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸

### iOS ç«¯

- [ ] èƒ½ä» Server è·å–çŠ¶æ€
- [ ] 7 ä¸ªçŠ¶æ€æŒ‰é’®èƒ½åˆ‡æ¢
- [ ] äº’åŠ¨æŒ‰é’®å·¥ä½œæ­£å¸¸
- [ ] Widget èƒ½æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
- [ ] ç¦»çº¿æ—¶æ˜¾ç¤ºç¼“å­˜
- [ ] ç¦»çº¿æç¤ºæ­£å¸¸æ˜¾ç¤º
- [ ] 60 ç§’è½®è¯¢æ­£å¸¸å·¥ä½œ
- [ ] device_id æ­£ç¡®ç”Ÿæˆå’Œä¿å­˜

### é›†æˆæµ‹è¯•

- [ ] iOS App èƒ½æ­£å¸¸è°ƒç”¨ Vercel API
- [ ] çŠ¶æ€åˆ‡æ¢åœ¨ Server å’Œ iOS åŒæ­¥
- [ ] Widget èƒ½è¯»å– App Group ç¼“å­˜
- [ ] ç½‘ç»œé”™è¯¯æ—¶é™çº§åˆ°ç¼“å­˜
- [ ] ç½‘ç»œæ¢å¤åè‡ªåŠ¨åˆ·æ–°

---

## é™„å½•

### A. API ç«¯ç‚¹é€ŸæŸ¥

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/health` | GET | å¥åº·æ£€æŸ¥ |
| `/api/pet/status` | GET | è·å–å® ç‰©çŠ¶æ€ |
| `/api/pet/change-state` | POST | åˆ‡æ¢çŠ¶æ€ï¼ˆM0.5 ç‰¹æœ‰ï¼‰ |
| `/api/pet/interact` | POST | äº’åŠ¨ï¼ˆfeed/play/greetï¼‰ |

### B. çŠ¶æ€æšä¸¾

```
sleep   - ç¡è§‰
hungry  - é¥¥é¥¿
play    - ç©è€
idle    - æ€è€ƒ
bored   - å‘å‘†
grumpy  - é—¹è„¾æ°”
sleepy  - å›°å€¦
```

### C. å‚è€ƒæ–‡æ¡£

- [Serverä¸ºçœŸæºæ¶æ„æ–¹æ¡ˆ.md](./Serverä¸ºçœŸæºæ¶æ„æ–¹æ¡ˆ.md) - æ•´ä½“æ¶æ„è®¾è®¡
- [M0.5 - çŠ¶æ€äº¤äº’Demoç‰ˆæœ¬.md](../../../Pet-Widget/docs/versions/M0.5%20-%20çŠ¶æ€äº¤äº’Demoç‰ˆæœ¬.md) - M0.5 äº§å“å®šä¹‰

---

**æ–‡æ¡£ç»´æŠ¤**: Ivy  
**æœ€åæ›´æ–°**: 2025-11-03  
**çŠ¶æ€**: âœ… å¾…å®æ–½


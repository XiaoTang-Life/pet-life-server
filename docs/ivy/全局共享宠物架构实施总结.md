# å…¨å±€å…±äº«å® ç‰©æ¶æ„å®æ–½æ€»ç»“

**æ–‡æ¡£ç±»å‹**: é¡¹ç›®çº§  
**é¡¹ç›®**: XiaoTang-Life / pet-life-server + Pet-Widget  
**é˜¶æ®µ**: Phase 6 - å…¨å±€å…±äº«å® ç‰©æ¨¡å¼  
**æ—¥æœŸ**: 2025-11-03  
**å®Œæˆæ—¥æœŸ**: 2025-11-03  
**çŠ¶æ€**: âœ… å®Œæˆ  
**ç‰ˆæœ¬**: v1.0  

> å®æ–½å…¨å±€å…±äº«å® ç‰©æ¨¡å¼ï¼šæ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€åªå°ç³–çš„å†…åœ¨çŠ¶æ€ï¼Œä½†æ¯ä¸ªç”¨æˆ·çœ‹åˆ°çš„è¡¨ç°ç‹¬ç«‹

---

## ğŸ“‹ ç›®å½•

- [1. æ¶æ„æ¦‚è¿°](#1-æ¶æ„æ¦‚è¿°)
- [2. æ ¸å¿ƒè®¾è®¡å†³ç­–](#2-æ ¸å¿ƒè®¾è®¡å†³ç­–)
- [3. å®æ–½å˜æ›´](#3-å®æ–½å˜æ›´)
- [4. æ•°æ®æµä¸äº¤äº’](#4-æ•°æ®æµä¸äº¤äº’)
- [5. ä»£ç å˜æ›´æ±‡æ€»](#5-ä»£ç å˜æ›´æ±‡æ€»)
- [6. æµ‹è¯•éªŒè¯](#6-æµ‹è¯•éªŒè¯)
- [7. ç”¨æˆ·ä½“éªŒè¯´æ˜](#7-ç”¨æˆ·ä½“éªŒè¯´æ˜)

---

## 1. æ¶æ„æ¦‚è¿°

### 1.1 æ ¸å¿ƒç†å¿µ

**"å…¨ä¸–ç•Œçš„ç”¨æˆ·å…±åŒå…»è‚²ä¸€åªå°ç³–ï¼Œä½†æ¯ä¸ªäººçœ‹åˆ°çš„è¡¨ç°ä¸åŒ"**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Serverï¼ˆå…¨å±€ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Lifeå¼•æ“ï¼ˆå…¨å±€å•ä¾‹ï¼‰                          â”‚   â”‚
â”‚  â”‚  - energy: 45.2                              â”‚   â”‚
â”‚  â”‚  - hunger: 67.8                              â”‚   â”‚
â”‚  â”‚  - mood: 52.3                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ æ•°å€¼åŒæ­¥ï¼ˆ60ç§’ç¼“å­˜ï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“               â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·A   â”‚    â”‚ ç”¨æˆ·B   â”‚    â”‚ ç”¨æˆ·C   â”‚    â”‚ ç”¨æˆ·D   â”‚
â”‚ iPhone  â”‚    â”‚ iPad    â”‚    â”‚ Android â”‚    â”‚ Web     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚æœ¬åœ°å†³å®šï¼šâ”‚    â”‚æœ¬åœ°å†³å®šï¼šâ”‚    â”‚æœ¬åœ°å†³å®šï¼šâ”‚    â”‚æœ¬åœ°å†³å®šï¼šâ”‚
â”‚çŠ¶æ€:idleâ”‚    â”‚çŠ¶æ€:playâ”‚    â”‚çŠ¶æ€:idleâ”‚    â”‚çŠ¶æ€:boredâ”‚
â”‚å¯¹è¯:ğŸ˜Š  â”‚    â”‚å¯¹è¯:ğŸ¾  â”‚    â”‚å¯¹è¯:ğŸ˜Œ  â”‚    â”‚å¯¹è¯:ğŸ˜‘  â”‚
â”‚æ˜µç§°:å°ç™½â”‚    â”‚æ˜µç§°:å°é»‘â”‚    â”‚æ˜µç§°:å°çº¢â”‚    â”‚æ˜µç§°:å°è“â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒè®¾è®¡å†³ç­–

### 2.1 ä»€ä¹ˆæ˜¯å…¨å±€å…±äº«çš„ï¼Ÿ

| é¡¹ç›® | å…±äº«èŒƒå›´ | å­˜å‚¨ä½ç½® | æ›´æ–°é¢‘ç‡ |
|------|---------|---------|---------|
| **energy** | ğŸŒ å…¨å±€ | Server Redis | å®æ—¶ |
| **hunger** | ğŸŒ å…¨å±€ | Server Redis | å®æ—¶ |
| **mood** | ğŸŒ å…¨å±€ | Server Redis | å®æ—¶ |
| **äº’åŠ¨å½±å“** | ğŸŒ å…¨å±€ | Server Lifeå¼•æ“ | ç«‹å³ |

### 2.2 ä»€ä¹ˆæ˜¯æœ¬åœ°ç‹¬ç«‹çš„ï¼Ÿ

| é¡¹ç›® | å…±äº«èŒƒå›´ | å­˜å‚¨ä½ç½® | å†³å®šå› ç´  |
|------|---------|---------|---------|
| **current_state** | ğŸ“± æœ¬åœ° | iOS App Group | RefreshStrategy + éšæœº |
| **dialogue** | ğŸ“± æœ¬åœ° | iOS App Group | DialogueLibrary + æ€§æ ¼ |
| **petName** | ğŸ“± æœ¬åœ° | iOS App Group | ç”¨æˆ·è‡ªå®šä¹‰ |
| **personality** | ğŸ“± æœ¬åœ° | iOS App Group | ç”¨æˆ·é€‰æ‹© |

### 2.3 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

#### âœ… ä¼˜åŠ¿

1. **å…¨å±€ä¸€è‡´æ€§**
   - ä»»ä½•äººå–‚é£Ÿ â†’ å…¨å±€hunger -20 â†’ æ‰€æœ‰äººéƒ½çœ‹åˆ°å˜åŒ–
   - é•¿æœŸæ•°å€¼è¶‹åŠ¿ä¸€è‡´ï¼ˆä¾‹å¦‚ï¼š24å°æ—¶åå…¨å±€èƒ½é‡éƒ½é™åˆ°30ï¼‰

2. **ä¿ç•™ä¸ªæ€§åŒ–ä½“éªŒ**
   - ä½ èµ·å"å°ç™½"ï¼Œæˆ‘èµ·å"å°é»‘" â†’ å„è‡ªçš„å® ç‰©æ˜µç§°
   - ä½ é€‰cheerfulæ€§æ ¼ï¼Œæˆ‘é€‰grumpyæ€§æ ¼ â†’ çœ‹åˆ°ä¸åŒçš„å¯¹è¯é£æ ¼
   - ä½ çœ‹åˆ°idleçŠ¶æ€ï¼Œæˆ‘çœ‹åˆ°playçŠ¶æ€ â†’ ä½“ç°"è§‚å¯Ÿè§†è§’"å·®å¼‚

3. **æˆæœ¬å¯æ§**
   - Serveråªéœ€ç»´æŠ¤ä¸€ä¸ªLifeå®ä¾‹ï¼ˆO(1)æˆæœ¬ï¼‰
   - æ— è®º10ä¸ªç”¨æˆ·è¿˜æ˜¯10ä¸‡ç”¨æˆ·ï¼ŒServerè´Ÿè½½ä¸€æ ·

4. **ç¦»çº¿å‹å¥½**
   - Serveræ•°å€¼60ç§’ç¼“å­˜ â†’ å³ä½¿ç½‘ç»œæ–­å¼€ï¼Œä»å¯å·¥ä½œ
   - æœ¬åœ°çŠ¶æ€å†³ç­– â†’ å®Œå…¨è‡ªä¸»ï¼Œ0å»¶è¿Ÿ

---

## 3. å®æ–½å˜æ›´

### 3.1 Serverç«¯å˜æ›´

#### A. `life_adapter.py` - å…¨å±€å•ä¾‹æ”¹é€ 

**å˜æ›´å‰**ï¼š
```python
# æ¯ä¸ªdevice_idä¸€ä¸ªLifeå®ä¾‹
_life_instances: Dict[str, Life] = {}

def __init__(self, device_id: str):
    self.device_id = device_id
    self._ensure_life_exists()  # åˆ›å»ºè®¾å¤‡ä¸“å±å®ä¾‹

def _create_storage_backend(self):
    return RedisStorage(
        key_prefix=f"life_{self.device_id}",  # æŒ‰è®¾å¤‡éš”ç¦»
        ttl=86400 * 7
    )
```

**å˜æ›´å**ï¼š
```python
# å…¨å±€å•ä¾‹Lifeå®ä¾‹
_global_life: Optional[Life] = None
_global_life_lock = threading.Lock()
GLOBAL_PET_ID = "global_pet"

def __init__(self, device_id: str):
    self.device_id = device_id  # ä»…ç”¨äºè¿½è¸ªæ¥æº
    self._ensure_global_life_exists()  # ç¡®ä¿å…¨å±€å®ä¾‹å­˜åœ¨

def _create_storage_backend(self):
    return RedisStorage(
        key_prefix=f"life_{self.GLOBAL_PET_ID}",  # å›ºå®šå‰ç¼€
        ttl=86400 * 30  # 30å¤©è¿‡æœŸ
    )

def _ensure_global_life_exists(self):
    if self._global_life is None:
        with self._global_life_lock:  # çº¿ç¨‹å®‰å…¨
            if self._global_life is None:  # Double-check
                # åˆ›å»ºå…¨å±€å®ä¾‹
                self._global_life = Life(...)
```

#### B. `life_adapter.py` - åˆ é™¤çŠ¶æ€åˆ¤æ–­

**å˜æ›´å‰**ï¼š
```python
def _derive_simplified_state(...) -> Dict[str, Any]:
    energy_value = self._extract_energy_value(...)
    hunger_value = self._extract_hunger_value(...)
    mood_value = self._extract_mood_value(...)
    
    # âŒ Serveråˆ¤æ–­çŠ¶æ€
    current_state = self._determine_state(energy, hunger, mood)
    
    return {
        "energy": energy_value,
        "hunger": hunger_value,
        "mood": mood_value,
        "current_state": current_state  # âŒ è¿”å›çŠ¶æ€
    }

def _determine_state(energy, hunger, mood) -> str:
    if hunger >= 70:
        return "hungry"
    # ... 30è¡Œé€»è¾‘
```

**å˜æ›´å**ï¼š
```python
def _derive_simplified_state(...) -> Dict[str, Any]:
    energy_value = self._extract_energy_value(...)
    hunger_value = self._extract_hunger_value(...)
    mood_value = self._extract_mood_value(...)
    
    # âœ… åªè¿”å›æ•°å€¼ï¼Œä¸åˆ¤æ–­çŠ¶æ€
    return {
        "energy": energy_value,
        "hunger": hunger_value,
        "mood": mood_value,
        # åˆ é™¤ï¼šcurrent_state
    }

# âœ… åˆ é™¤æ•´ä¸ª _determine_state() æ–¹æ³•
```

#### C. `models.py` - æ•°æ®æ¨¡å‹è°ƒæ•´

**å˜æ›´å‰**ï¼š
```python
class PetState(BaseModel):
    device_id: str
    energy: float
    hunger: float
    mood: float
    current_state: str  # âŒ Serverå†³å®šçš„çŠ¶æ€
    last_updated: datetime
```

**å˜æ›´å**ï¼š
```python
class PetState(BaseModel):
    """å…¨å±€å® ç‰©çŠ¶æ€"""
    device_id: str  # è¯·æ±‚æ¥æºï¼ˆä»…è¿½è¸ªï¼‰
    energy: float   # å…¨å±€å…±äº«
    hunger: float   # å…¨å±€å…±äº«
    mood: float     # å…¨å±€å…±äº«
    last_updated: datetime
    # åˆ é™¤ï¼šcurrent_state
```

---

### 3.2 iOSç«¯å˜æ›´

#### A. `RefreshStrategy.swift` - æ¥å—Serveræ•°å€¼

**å˜æ›´å‰**ï¼š
```swift
static func shouldChangeState(current: PetStateEnum) -> Bool {
    let keepProb = keepProbability(for: current)
    let randomValue = Double.random(in: 0...1)
    return randomValue > keepProb
}
```

**å˜æ›´å**ï¼š
```swift
// æ–°å¢æ–¹æ³•ï¼šä½¿ç”¨Serveræ•°å€¼è°ƒæ•´æ¦‚ç‡
static func shouldChangeState(
    current: PetStateEnum,
    energy: Double,   // â† ä»Serverè·å–
    hunger: Double,   // â† ä»Serverè·å–
    mood: Double      // â† ä»Serverè·å–
) -> Bool {
    var keepProb = keepProbability(for: current)
    
    // æ ¹æ®Serveræ•°å€¼è°ƒæ•´æ¦‚ç‡
    if hunger > 70 {
        keepProb *= 0.7  // é¥¥é¥¿æ—¶æ›´æ˜“åˆ‡æ¢
    }
    if energy < 30 {
        keepProb *= 0.8  // ç–²åŠ³æ—¶æ›´æ˜“åˆ‡æ¢
    }
    if mood < 30 {
        keepProb *= 0.8  // å¿ƒæƒ…å·®æ—¶æ›´æ˜“åˆ‡æ¢
    }
    
    // ç¡®ä¿æ¦‚ç‡åœ¨åˆç†èŒƒå›´
    keepProb = max(0.2, min(0.95, keepProb))
    
    let randomValue = Double.random(in: 0...1)
    return randomValue > keepProb
}
```

#### B. `PetServerAPI.swift` - æ–°å»ºAPIæœåŠ¡å±‚

```swift
actor PetServerAPI {
    /// è·å–å…¨å±€å® ç‰©æ•°å€¼
    func getPetValues() async throws -> (energy: Double, hunger: Double, mood: Double) {
        // æ£€æŸ¥ç¼“å­˜ï¼ˆ60ç§’æœ‰æ•ˆï¼‰
        if let cached = cachedValues,
           Date().timeIntervalSince(cached.timestamp) < 60.0 {
            return (cached.energy, cached.hunger, cached.mood)
        }
        
        // è¯·æ±‚Server
        let url = URL(string: "\(baseURL)/api/pet/status?device_id=\(deviceID)")!
        let (data, _) = try await URLSession.shared.data(from: url)
        let result = try JSONDecoder().decode(PetStatusResponse.self, from: data)
        
        // æå–æ•°å€¼
        let values = (
            energy: result.data.simplified_state.energy,
            hunger: result.data.simplified_state.hunger,
            mood: result.data.simplified_state.mood
        )
        
        // æ›´æ–°ç¼“å­˜
        cachedValues = CachedPetValues(...)
        
        return values
    }
    
    /// å‘é€äº’åŠ¨è¯·æ±‚
    func interact(action: String) async throws {
        // POST /api/pet/interact
        // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡åˆ·æ–°
    }
}
```

#### C. `PetAutoRefreshManager.swift` - é›†æˆServeræ•°å€¼

**å˜æ›´å‰**ï¼š
```swift
private func performRefresh() {
    // æœ¬åœ°å†³å®šæ˜¯å¦åˆ‡æ¢çŠ¶æ€
    let shouldChange = RefreshStrategy.shouldChangeState(current: currentState)
    
    if shouldChange {
        currentState = selectNewState()
        currentDialogue = loadCurrentDialogue()
    }
    
    // ...
}
```

**å˜æ›´å**ï¼š
```swift
private let serverAPI: PetServerAPI
private var cachedServerValues: (energy: Double, hunger: Double, mood: Double)?
private let defaultValues = (energy: 75.0, hunger: 40.0, mood: 60.0)

private func performRefresh() {
    Task {
        // 1. è·å–Serveræ•°å€¼ï¼ˆå¼‚æ­¥ï¼‰
        let serverValues = await fetchServerValues()
        
        // 2. ä½¿ç”¨Serveræ•°å€¼å†³å®šæ˜¯å¦åˆ‡æ¢
        let shouldChange = RefreshStrategy.shouldChangeState(
            current: currentState,
            energy: serverValues.energy,
            hunger: serverValues.hunger,
            mood: serverValues.mood
        )
        
        if shouldChange {
            currentState = selectNewState()
            currentDialogue = loadCurrentDialogue()
        }
        
        // ...
    }
}

private func fetchServerValues() async -> (...) {
    do {
        let values = try await serverAPI.getPetValues()
        cachedServerValues = values  // æ›´æ–°ç¼“å­˜
        return values
    } catch {
        // å¤±è´¥æ—¶ä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤å€¼
        return cachedServerValues ?? defaultValues
    }
}
```

---

## 4. æ•°æ®æµä¸äº¤äº’

### 4.1 æ­£å¸¸åˆ·æ–°æµç¨‹

```
æ—¶é—´çº¿: 13:00:00

1. iOSè§¦å‘åˆ·æ–°ï¼ˆæ¯5-10ç§’ï¼‰
   PetAutoRefreshManager.performRefresh()

2. è¯·æ±‚Serveræ•°å€¼
   serverAPI.getPetValues()
   â†“
   GET /api/pet/status?device_id=iphone-123
   â†“
   Server: LifeAdapter.get_state()
   â†“
   è¿”å›: {energy: 45.2, hunger: 67.8, mood: 52.3}

3. iOSç¼“å­˜æ•°å€¼ï¼ˆ60ç§’ï¼‰
   cachedServerValues = (45.2, 67.8, 52.3)

4. iOSå†³å®šçŠ¶æ€
   RefreshStrategy.shouldChangeState(
       current: "idle",
       energy: 45.2,
       hunger: 67.8,
       mood: 52.3
   )
   â†“
   è®¡ç®—æ¦‚ç‡ï¼šåŸºç¡€50% Ã— 0.7ï¼ˆhungeré«˜ï¼‰ = 35%
   â†“
   éšæœºæ•°ï¼š0.6 > 0.35 â†’ åˆ‡æ¢ï¼

5. iOSç”Ÿæˆå¯¹è¯
   DialogueLibrary.getDialogue(
       state: "hungry",
       personality: .cheerful
   )
   â†“
   è¿”å›ï¼š"è‚šå­å’•å’•å«å•¦ï¼ğŸ•"

6. iOSæ›´æ–°UI
   currentState = "hungry"
   currentDialogue = "è‚šå­å’•å’•å«å•¦ï¼ğŸ•"
```

### 4.2 ç”¨æˆ·äº’åŠ¨æµç¨‹

```
æ—¶é—´çº¿: 13:05:00

ç”¨æˆ·ç‚¹å‡»"å–‚é£Ÿ"æŒ‰é’®

1. iOSå‘é€äº’åŠ¨è¯·æ±‚
   serverAPI.interact(action: "feed")
   â†“
   POST /api/pet/interact
   Body: {device_id: "iphone-123", action: "feed"}

2. Serverå¤„ç†ï¼ˆå½±å“å…¨å±€ï¼‰
   LifeAdapter.interact("feed")
   â†“
   Lifeå¼•æ“æ‰§è¡Œtick()
   â†“
   å…¨å±€hunger: 67.8 â†’ 45.3ï¼ˆ-22.5ï¼‰
   â†“
   flushåˆ°Redisï¼ˆå…¨å±€çŠ¶æ€æ›´æ–°ï¼‰

3. iOSæ¸…é™¤ç¼“å­˜
   cachedServerValues = nil

4. ä¸‹æ¬¡åˆ·æ–°æ—¶è·å–æ–°æ•°å€¼
   13:05:05 - è¯·æ±‚Server
   â†“
   è¿”å›: {energy: 44.8, hunger: 45.3, mood: 55.1}
   â†“
   RefreshStrategyä½¿ç”¨æ–°æ•°å€¼è°ƒæ•´æ¦‚ç‡
```

### 4.3 å¤šç”¨æˆ·åŒæ­¥ç¤ºä¾‹

```
æ—¶é—´çº¿: 13:00:00 - Serverå…¨å±€çŠ¶æ€

energy: 60.0
hunger: 50.0
mood: 70.0

ç”¨æˆ·A (iPhone)ï¼š
  13:00:05 - è·å–æ•°å€¼ (60, 50, 70)
  13:00:05 - å†³å®šçŠ¶æ€ â†’ "idle"
  13:00:05 - ç”Ÿæˆå¯¹è¯ â†’ "ä»Šå¤©å¿ƒæƒ…ä¸é”™å“¦ï¼"

ç”¨æˆ·B (iPad)ï¼š
  13:00:08 - è·å–æ•°å€¼ (60, 50, 70)
  13:00:08 - å†³å®šçŠ¶æ€ â†’ "play"ï¼ˆéšæœºä¸åŒï¼‰
  13:00:08 - ç”Ÿæˆå¯¹è¯ â†’ "æ¥ç©å§ï¼"

æ—¶é—´çº¿: 13:05:00 - ç”¨æˆ·Bå–‚é£Ÿ

ç”¨æˆ·B: serverAPI.interact("feed")
  â†“
  Server: hunger 50 â†’ 30

ç”¨æˆ·A:
  13:05:10 - è·å–æ•°å€¼ (58, 30, 72)ï¼ˆhungerå·²å˜ï¼‰
  13:05:10 - RefreshStrategyè°ƒæ•´æ¦‚ç‡ï¼ˆhunger<30 â†’ æ›´ç¨³å®šï¼‰
  13:05:10 - çŠ¶æ€ä¿æŒ "idle"ï¼ˆæ¦‚ç‡å½±å“ï¼‰

ç”¨æˆ·B:
  13:05:12 - è·å–æ•°å€¼ (58, 30, 72)
  13:05:12 - RefreshStrategyè°ƒæ•´æ¦‚ç‡
  13:05:12 - çŠ¶æ€ä¿æŒ "play"
```

---

## 5. ä»£ç å˜æ›´æ±‡æ€»

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | ä»£ç è¡Œæ•° | è¯´æ˜ |
|------|---------|---------|------|
| **Serverç«¯** | | | |
| `life_adapter.py` | æ”¹é€  | ~150è¡Œä¿®æ”¹ | å…¨å±€å•ä¾‹ã€åˆ é™¤çŠ¶æ€åˆ¤æ–­ |
| `models.py` | åˆ é™¤ | -5è¡Œ | åˆ é™¤current_stateå­—æ®µ |
| **iOSç«¯** | | | |
| `RefreshStrategy.swift` | æ–°å¢ | +45è¡Œ | å¢åŠ Serveræ•°å€¼ç‰ˆæœ¬ |
| `PetServerAPI.swift` | æ–°å¢ | +150è¡Œ | åˆ›å»ºAPIæœåŠ¡å±‚ |
| `PetAutoRefreshManager.swift` | æ”¹é€  | +40è¡Œ | é›†æˆServeræ•°å€¼ |
| `UserSettings.swift` | æ³¨é‡Š | +10è¡Œæ³¨é‡Š | æ·»åŠ æ¶æ„è¯´æ˜ |
| **æ€»è®¡** | | **+390è¡Œ** | |

---

## 6. æµ‹è¯•éªŒè¯

### 6.1 Serverç«¯æµ‹è¯•

#### æµ‹è¯•1ï¼šå…¨å±€å•ä¾‹éªŒè¯

```bash
# æµ‹è¯•å¤šä¸ªdevice_idæ˜¯å¦å…±äº«åŒä¸€Lifeå®ä¾‹

curl "https://pet-life-server.vercel.app/api/pet/status?device_id=device-A"
# è¿”å›: energy=60, hunger=50, mood=70

curl "https://pet-life-server.vercel.app/api/pet/status?device_id=device-B"
# åº”è¿”å›ç›¸åŒçš„æ•°å€¼: energy=60, hunger=50, mood=70

# éªŒè¯Redis key
# åº”è¯¥åªæœ‰ä¸€ä¸ªkey: life_global_pet
```

#### æµ‹è¯•2ï¼šäº’åŠ¨å…¨å±€å½±å“

```bash
# ç”¨æˆ·Aå–‚é£Ÿ
curl -X POST https://pet-life-server.vercel.app/api/pet/interact \
  -H "Content-Type: application/json" \
  -d '{"device_id":"device-A","action":"feed"}'

# ç”¨æˆ·BæŸ¥è¯¢ï¼ˆåº”çœ‹åˆ°hungerä¸‹é™ï¼‰
curl "https://pet-life-server.vercel.app/api/pet/status?device_id=device-B"
# hungeråº”è¯¥å·²ç»å˜åŒ–
```

### 6.2 iOSç«¯æµ‹è¯•

#### æµ‹è¯•3ï¼šRefreshStrategyæ•°å€¼å½±å“

```swift
// æµ‹è¯•é¥¥é¥¿å€¼å½±å“æ¦‚ç‡
let result1 = RefreshStrategy.shouldChangeState(
    current: .idle,
    energy: 60,
    hunger: 80,  // é«˜é¥¥é¥¿
    mood: 60
)
// åº”è¯¥æ¯”åŸºç¡€æ¦‚ç‡æ›´å®¹æ˜“åˆ‡æ¢

let result2 = RefreshStrategy.shouldChangeState(
    current: .idle,
    energy: 60,
    hunger: 20,  // ä½é¥¥é¥¿
    mood: 60
)
// åº”è¯¥æ¯”åŸºç¡€æ¦‚ç‡æ›´éš¾åˆ‡æ¢
```

#### æµ‹è¯•4ï¼šAPIç¼“å­˜éªŒè¯

```swift
// ç¬¬ä¸€æ¬¡è¯·æ±‚
let values1 = try await serverAPI.getPetValues()
print("ç¬¬ä¸€æ¬¡: \(values1)")  // åº”è¯¥æœ‰ç½‘ç»œè¯·æ±‚

// ç«‹å³ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆ60ç§’å†…ï¼‰
let values2 = try await serverAPI.getPetValues()
print("ç¬¬äºŒæ¬¡: \(values2)")  // åº”è¯¥ä½¿ç”¨ç¼“å­˜ï¼Œæ— ç½‘ç»œè¯·æ±‚

// åº”è¯¥è¿”å›ç›¸åŒçš„å€¼
XCTAssertEqual(values1, values2)
```

---

## 7. ç”¨æˆ·ä½“éªŒè¯´æ˜

### 7.1 å¯¹ç”¨æˆ·çš„å½±å“

#### âœ… ç”¨æˆ·ä¼šæ„ŸçŸ¥åˆ°çš„å˜åŒ–

1. **é•¿æœŸæ•°å€¼è¶‹åŠ¿ä¸€è‡´**
   - ä½ 24å°æ—¶ä¸æ‰“å¼€Appï¼Œå°ç³–çš„é¥¥é¥¿å€¼ä¼šæ¶¨åˆ°70+
   - å› ä¸ºè¿™æ˜¯å…¨å±€æ•°å€¼ï¼Œæ‰€æœ‰äººéƒ½çœ‹åˆ°ç›¸åŒçš„è¶‹åŠ¿

2. **äº’åŠ¨æœ‰å…¨å±€å½±å“**
   - ä½ å–‚é£Ÿåï¼Œå…¶ä»–ç”¨æˆ·ä¸‹æ¬¡åˆ·æ–°æ—¶ä¹Ÿä¼šçœ‹åˆ°é¥¥é¥¿å€¼ä¸‹é™
   - è¿™å¢å¼ºäº†"å…±åŒå…»è‚²"çš„ç¤¾äº¤æ„Ÿ

#### âŒ ç”¨æˆ·ä¸ä¼šæ„ŸçŸ¥åˆ°çš„å˜åŒ–

1. **çŠ¶æ€å’Œå¯¹è¯ä»ç„¶ç‹¬ç«‹**
   - ä½ çœ‹åˆ°"idle"çŠ¶æ€ï¼Œåˆ«äººå¯èƒ½çœ‹åˆ°"play"çŠ¶æ€
   - ä½ çœ‹åˆ°"ä»Šå¤©å¤©æ°”çœŸå¥½ï¼"ï¼Œåˆ«äººå¯èƒ½çœ‹åˆ°"æœ‰ç‚¹æ— èŠ..."
   - è¿™ä¿ç•™äº†ä¸ªæ€§åŒ–ä½“éªŒ

2. **æ˜µç§°å’Œè®¾ç½®å®Œå…¨ç‹¬ç«‹**
   - ä½ å«å®ƒ"å°ç™½"ï¼Œåˆ«äººå«å®ƒ"å°é»‘"
   - ä½ é€‰cheerfulæ€§æ ¼ï¼Œåˆ«äººé€‰grumpyæ€§æ ¼
   - è¿™äº›éƒ½ä¸ä¼šäº’ç›¸å½±å“

### 7.2 å…¸å‹åœºæ™¯

#### åœºæ™¯1ï¼šæ—©ä¸Šèµ·åºŠ

```
08:00 AM - å…¨å±€çŠ¶æ€

energy: 30 (ç¡äº†ä¸€å¤œï¼Œèƒ½é‡ä½)
hunger: 75 (ä¸€å¤œæœªè¿›é£Ÿï¼Œé¥¥é¥¿é«˜)
mood: 50

ç”¨æˆ·Aï¼ˆä½ ï¼‰ï¼š
  çœ‹åˆ°ï¼šçŠ¶æ€=sleepyï¼Œå¯¹è¯="è¿˜æƒ³å†ç¡ä¸€ä¼šå„¿..."
  åŸå› ï¼šenergyä½ï¼ŒRefreshStrategyæ¦‚ç‡è°ƒæ•´ â†’ æ›´æ˜“è¿›å…¥sleepy

ç”¨æˆ·Bï¼ˆåˆ«äººï¼‰ï¼š
  çœ‹åˆ°ï¼šçŠ¶æ€=hungryï¼Œå¯¹è¯="è‚šå­å¥½é¥¿ï¼"
  åŸå› ï¼šhungeré«˜ï¼ŒRefreshStrategyéšæœºé€‰æ‹© â†’ é€‰äº†hungry

å…¨å±€æ•°å€¼ä¸€æ ·ï¼Œä½†è¡¨ç°ä¸åŒï¼
```

#### åœºæ™¯2ï¼šåˆé¤æ—¶é—´

```
12:00 PM - ç”¨æˆ·Aå–‚é£Ÿ

ç”¨æˆ·Aç‚¹å‡»"å–‚é£Ÿ" â†’
  Server: hunger 75 â†’ 50
  iOSæ¸…é™¤ç¼“å­˜

12:01 PM - ç”¨æˆ·Båˆ·æ–°

ç”¨æˆ·Bçš„Appï¼š
  è¯·æ±‚Server â†’ è·å–hunger=50
  RefreshStrategyè°ƒæ•´ï¼šhunger<70ï¼Œæ¦‚ç‡æ›´ç¨³å®š
  çŠ¶æ€å¯èƒ½ä¿æŒplayï¼ˆå› ä¸ºä¸å†é¥¥é¥¿ï¼‰
  å¯¹è¯åˆ‡æ¢ï¼š"ç©å¾—å¥½å¼€å¿ƒï¼"
```

#### åœºæ™¯3ï¼šæ·±å¤œ

```
02:00 AM - å…¨å±€çŠ¶æ€

energy: 15 (æåº¦ç–²æƒ«)
hunger: 60
mood: 40

ç”¨æˆ·Aï¼ˆè¿˜åœ¨ç”¨æ‰‹æœºï¼‰ï¼š
  çœ‹åˆ°ï¼šçŠ¶æ€=sleepï¼Œå¯¹è¯="å‘¼å‘¼å‘¼...ğŸ’¤"
  åŸå› ï¼šenergy<30ï¼ŒRefreshStrategyå¼ºçƒˆå€¾å‘sleep

ç”¨æˆ·Bï¼ˆç¬¬äºŒå¤©æ—©ä¸Šæ‰“å¼€ï¼‰ï¼š
  çœ‹åˆ°ï¼šçŠ¶æ€=sleepyï¼Œå¯¹è¯="å¥½å›°å•Š..."
  åŸå› ï¼šè™½ç„¶energyå·²æ¢å¤ï¼Œä½†éšæœºé€‰äº†sleepy

ç”¨æˆ·Cï¼ˆç¬¬äºŒå¤©æ—©ä¸Šæ‰“å¼€ï¼‰ï¼š
  çœ‹åˆ°ï¼šçŠ¶æ€=idleï¼Œå¯¹è¯="æ˜¨æ™šç¡å¾—ä¸é”™"
  åŸå› ï¼šenergyæ¢å¤ï¼Œéšæœºé€‰äº†idle
```

---

## 8. åç»­ä¼˜åŒ–æ–¹å‘

### 8.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. **Serverå®šæ—¶ä»»åŠ¡**
   - æ¯1å°æ—¶è‡ªåŠ¨tickä¸€æ¬¡Lifeå¼•æ“
   - æ¨¡æ‹Ÿæ—¶é—´æµé€ï¼ˆé¥¥é¥¿å€¼å¢åŠ ã€èƒ½é‡æ¶ˆè€—ï¼‰
   - æ— éœ€ç­‰å¾…ç”¨æˆ·è¯·æ±‚

2. **æ¨é€é€šçŸ¥é›†æˆ**
   - å½“å…¨å±€hunger>90æ—¶ï¼Œç»™æ‰€æœ‰ç”¨æˆ·å‘æ¨é€ï¼š"å°ç³–é¥¿åäº†ï¼"
   - å½“å…¨å±€energy<10æ—¶ï¼š"å°ç³–å¿«è¦ç¡ç€äº†..."

3. **äº’åŠ¨æ•ˆæœä¼˜åŒ–**
   - "feed"ç›´æ¥ä¿®æ”¹hungerå€¼ï¼ˆä¸åªæ˜¯tickï¼‰
   - "play"æ¶ˆè€—energyï¼Œå¢åŠ mood
   - "greet"å¢åŠ mood

### 8.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰

1. **ç¤¾äº¤åŠŸèƒ½**
   - æ˜¾ç¤º"æœ€è¿‘å–‚é£Ÿè®°å½•"ï¼šç”¨æˆ·Aåœ¨5åˆ†é’Ÿå‰å–‚é£Ÿäº†å°ç³–
   - äº’åŠ¨æ’è¡Œæ¦œï¼šè°å–‚é£Ÿæ¬¡æ•°æœ€å¤š
   - å…¨å±€äº‹ä»¶ï¼š"å°ç³–åˆšåˆšåƒé¥±äº†ï¼æ„Ÿè°¢ç”¨æˆ·B"

2. **Serverä¸»åŠ¨è¡Œä¸º**
   - å®šæ—¶ä»»åŠ¡æŒç»­æ¨è¿›Lifeå¼•æ“
   - å¯ä»¥åœ¨ç‰¹å®šæ—¶é—´è§¦å‘äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼šæ¯å¤©8AMï¼Œå°ç³–è¯´"æ—©å®‰ï¼"ï¼‰

3. **å¤šç«¯åŒæ­¥ä¼˜åŒ–**
   - WebSocketå®æ—¶æ¨é€æ•°å€¼å˜åŒ–
   - å‡å°‘ç¼“å­˜æ—¶é—´ï¼ˆ60ç§’ â†’ 10ç§’ï¼‰

### 8.3 é•¿æœŸæ„¿æ™¯ï¼ˆ3-6æœˆï¼‰

1. **å¤šåªå® ç‰©**
   - æ¯ä¸ªå…¨å±€å® ç‰©æœ‰ä¸åŒæ€§æ ¼å’Œè¡Œä¸ºæ¨¡å¼
   - ç”¨æˆ·å¯ä»¥é€‰æ‹©å…³æ³¨å“ªåªå® ç‰©

2. **ç¾¤ä½“è¡Œä¸º**
   - å¤šåªå® ç‰©ä¹‹é—´å¯ä»¥äº’åŠ¨
   - å® ç‰©ç¤¾åŒºã€å® ç‰©ä¸–ç•Œ

3. **è¿›åŒ–ç³»ç»Ÿ**
   - é•¿æœŸäº’åŠ¨ç§¯ç´¯å½±å“å® ç‰©è¿›åŒ–
   - ä¸åŒçš„å…¨å±€é€‰æ‹©å¯¼è‡´ä¸åŒçš„è¿›åŒ–åˆ†æ”¯

---

## 9. æ€»ç»“

### 9.1 å…³é”®æˆæœ

âœ… **æ¶æ„æ¸…æ™°**
- Serveråªè´Ÿè´£æ•°å€¼è®¡ç®—ï¼ˆå…¨å±€å…±äº«ï¼‰
- å®¢æˆ·ç«¯è´Ÿè´£çŠ¶æ€å†³ç­–ï¼ˆæœ¬åœ°ç‹¬ç«‹ï¼‰
- èŒè´£è¾¹ç•Œæ˜ç¡®

âœ… **ä½“éªŒå¹³è¡¡**
- å…¨å±€å…±äº«å¢å¼ºç¤¾äº¤æ„Ÿ
- æœ¬åœ°ç‹¬ç«‹ä¿ç•™ä¸ªæ€§åŒ–
- ä¸¤è€…å…¼é¡¾ï¼Œäº’ä¸å†²çª

âœ… **æˆæœ¬å¯æ§**
- Server O(1)èµ„æºæ¶ˆè€—
- å®¢æˆ·ç«¯å®Œå…¨è‡ªä¸»è¿è¡Œ
- ç¦»çº¿å‹å¥½ï¼Œç½‘ç»œé™çº§

âœ… **æ‰©å±•æ€§å¼º**
- æ˜“äºæ·»åŠ ç¤¾äº¤åŠŸèƒ½
- æ˜“äºæ·»åŠ æ¨é€é€šçŸ¥
- æ˜“äºæ‰©å±•åˆ°å¤šç«¯

### 9.2 æŠ€æœ¯äº®ç‚¹

1. **å…¨å±€å•ä¾‹ + çº¿ç¨‹å®‰å…¨**
   - ä½¿ç”¨Double-Check Locking
   - Rediså…¨å±€keyéš”ç¦»
   - å®Œç¾æ”¯æŒServerless

2. **æ¦‚ç‡å¼çŠ¶æ€å†³ç­–**
   - Serveræ•°å€¼å½±å“æ¦‚ç‡ï¼Œä¸å†³å®šçŠ¶æ€
   - ä¿æŒéšæœºæ€§å’Œç‹¬ç«‹æ€§
   - å¯è§£é‡Šã€å¯è°ƒä¼˜

3. **å¤šå±‚ç¼“å­˜é™çº§**
   - 60ç§’APIç¼“å­˜
   - ç½‘ç»œå¤±è´¥é™çº§åˆ°ç¼“å­˜å€¼
   - ç¼“å­˜å¤±è´¥é™çº§åˆ°é»˜è®¤å€¼
   - ä¸‰å±‚ä¿éšœï¼Œæ°¸ä¸å´©æºƒ

4. **Actorå¹¶å‘æ¨¡å‹**
   - iOSä½¿ç”¨actorä¿è¯APIçº¿ç¨‹å®‰å…¨
   - è‡ªåŠ¨ç®¡ç†å¼‚æ­¥è¯·æ±‚
   - ç®€æ´ã€å®‰å…¨ã€é«˜æ•ˆ

---

**å®Œæˆæ—¶é—´**: 2025-11-03  
**å®æ–½è€…**: AI Assistant + Ivy  
**é¡¹ç›®çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª  
**ä¸‹ä¸€æ­¥**: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œå¼€å§‹ç”¨æˆ·æµ‹è¯•

---

